audio.onplaying = () => {
          document.getElementById('status').textContent = 'üî¥ –í —ç—Ñ–∏—Ä–µ';
        };
      }
    }

    function switchStation(station) {
      currentStation = station;

      document.getElementById('btn-jpop').classList.toggle('active', station === 'jpop');
      document.getElementById('btn-kpop').classList.toggle('active', station === 'kpop');

      // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
      connectWS();

      // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –ø–æ—Ç–æ–∫
      if (playing) {
        audio.src = streams[station];
        audio.play();
      }
    }

    function setVolume(val) {
      audio.volume = val / 100;
    }

    // --- WebSocket –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö ---
    function connectWS() {
      if (ws) ws.close();
      if (heartbeatInterval) clearInterval(heartbeatInterval);

      ws = new WebSocket(wsUrls[currentStation]);

      ws.onopen = () => {
        console.log('WS connected');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.op === 0) {
          // HELLO ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º heartbeat
          const interval = data.d.heartbeat;
          heartbeatInterval = setInterval(() => {
            ws.send(JSON.stringify({ op: 9 }));
          }, interval);
        }

        if (data.op === 1 && data.t === 'TRACK_UPDATE') {
          const song = data.d.song;
          const title = song.title || 'Unknown';
          const artists = song.artists
            ? song.artists.map(a => a.nameRomaji || a.name).join(', ')
            : 'Unknown';

          document.getElementById('track-title').textContent = title;
          document.getElementById('track-artist').textContent = artists;

          // –û–±–ª–æ–∂–∫–∞
          if (song.albums && song.albums[0] && song.albums[0].image) {
            document.getElementById('cover-img').src =
              'https://cdn.listen.moe/covers/' + song.albums[0].image;
          } else {
            document.getElementById('cover-img').src =
              'https://listen.moe/images/logo.png';
          }
        }
      };

      ws.onclose = () => {
        // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        setTimeout(() => connectWS(), 5000);
      };
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º WebSocket —Å—Ä–∞–∑—É
    connectWS();
  </script>
</body>
</html>
